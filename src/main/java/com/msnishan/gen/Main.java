package com.msnishan.gen;

import org.apache.velocity.Template;
import org.apache.velocity.VelocityContext;
import org.apache.velocity.app.VelocityEngine;
import org.apache.velocity.runtime.RuntimeConstants;
import org.apache.velocity.runtime.resource.loader.ClasspathResourceLoader;
import org.yaml.snakeyaml.Yaml;

import java.io.*;
import java.text.MessageFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

/**
 *
 *
 */
public class Main
{
    private static final Map<String, String> COLLECTION_TYPES = new HashMap<>();
    private static final String BASE_LOCATION = System.getenv("project.loc");
    static {
        COLLECTION_TYPES.put("List", "java.util.List");
        COLLECTION_TYPES.put("Set", "java.util.Set");
        COLLECTION_TYPES.put("Map", "java.util.Map");
    }
    public static void main (String[] args)
    {
        String baseLocation = args.length != 0 ? args[0] : BASE_LOCATION;
        Yaml yaml = new Yaml();
        Map<String, Object> models = yaml.load(Main.class.getClassLoader().getResourceAsStream("models2.yml"));

        ModelList modelList;

        modelList = retrieveModelsList(models);
        System.out.println(modelList);
        VelocityEngine ve = new VelocityEngine();
        ve.setProperty(RuntimeConstants.RESOURCE_LOADER, "classpath");
        ve.setProperty("classpath.resource.loader.class", ClasspathResourceLoader.class.getName());
        
        ve.init();
        Template modelTemplate = ve.getTemplate("ModelEngine.vm");
        
        for (Model model : modelList.getModels()) {
            StringBuilder importStatements = new StringBuilder();
            VelocityContext ctx = new VelocityContext();

            String packageName = model.getPackageName() != null ? model.getPackageName() : modelList.getBasePackage();

            ctx.put("Package", MessageFormat.format("package {0};", packageName));
            ctx.put("GeneratedStatement", "Generated by model-gen framework");
            ctx.put("ClassNameUpper", model.getName());
            ctx.put("ModelType", model.getType());
            ctx.put("Imports", importStatements);
            updateAttributes(model, modelList, importStatements);
            Map<String, Attribute> attrMap = model.getAttributes().stream()
                    .collect(Collectors.toMap(Attribute::getName, Function.identity()));
            ctx.put("attrMap", attrMap);
            String path = baseLocation +"/src/main/javaGen/" + packageName.replace(".", "/");

            if (!new File(path).exists()) {
                new File(path).mkdirs();
            }

            String fileName = model.getName() + model.getType() + ".java";
            try (PrintWriter pt = new PrintWriter(path + "/" + fileName)) {
                modelTemplate.merge(ctx, pt);
            }
            catch (FileNotFoundException e)
            {
                e.printStackTrace();
            }
        }

    }

    private static ModelList retrieveModelsList(Map<String,Object> models) {

        ModelList modelPojoList = new ModelList();
        modelPojoList.setModels(new ArrayList<>());
        String basePackage = (String) models.get("basePackage");

        modelPojoList.setBasePackage(basePackage);
        Map<String, Object> modelList = (Map<String, Object>) models.get("models");
        for (String modelKey: modelList.keySet()) {
            Model model = new Model();
            Map<String, Object> modelDetails = (Map<String, Object>) modelList.get(modelKey);
            String modelPackageName = (String) modelDetails.get("package");
            String modelType = (String) modelDetails.get("type");

            model.setName(modelKey);
            model.setPackageName(modelPackageName);
            model.setType(modelType);
            model.setAttributes(new ArrayList<>());
            Map<String, Object> attributes = (Map<String, Object>) modelDetails.get("attributes");
            for (Map.Entry<String, Object> entry: attributes.entrySet()) {
                Attribute attribute = new Attribute();
                Map<String, String> attributeData = (Map<String, String>) entry.getValue();

                attribute.setName(entry.getKey());
                attribute.setType(attributeData.get("type"));
                attribute.setJsonAttributeName(attributeData.get("jsonAttributeName"));

                model.getAttributes().add(attribute);
            }
            modelPojoList.getModels().add(model);

        }
        return modelPojoList;

    }

    private static void updateAttributes(Model model, ModelList modelList, StringBuilder importStatements) {

        Map<String, Attribute> attrMap = model.getAttributes().stream()
                .collect(Collectors.toMap(Attribute::getName, Function.identity()));

        for (Map.Entry<String, Attribute> entry : attrMap.entrySet())
        {
            if (entry.getValue().getType().contains("$")) {
                String modelName = entry.getValue().getType().contains(":") ?
                            entry.getValue().getType().substring(1, entry.getValue().getType().indexOf(":"))
                                    : entry.getValue().getType().substring(1);
                Model targetModel = modelList.getModels().stream()
                                    .filter( mod -> mod.getName().equals(modelName))
                                    .findFirst().get();
                updateImportStatement(model, targetModel, importStatements);
                entry.getValue().setType(entry.getValue().getType().substring(1)
                        .replace(modelName, targetModel.getName() + targetModel.getType()));
            }
            if (entry.getValue().getType().contains(":")) {
                String genericType = entry.getValue().getType().substring(entry.getValue().getType().indexOf(":") + 1);
                String modelType = entry.getValue().getType().substring(0, entry.getValue().getType().indexOf(":"));
                updateImportStatement(genericType, importStatements);
                entry.getValue().setType(MessageFormat.format("{0}<{1}>", genericType, modelType));
            }
        }
    }

    private static void updateImportStatement(String genericType, StringBuilder importStatements) {
        String importStatement = MessageFormat.format("import {0};\n", COLLECTION_TYPES.get(genericType));
        if (!importStatements.toString().contains(importStatement)) {
            importStatements.append(importStatement);
        }
    }

    private static void updateImportStatement(Model model, Model targetModel, StringBuilder importStatements) {
        if (!targetModel.getPackageName().equals(model.getPackageName())) {
            importStatements.append(MessageFormat.format("import {0}.{1}{2};\n",
                    targetModel.getPackageName(), targetModel.getName(), targetModel.getType()));
        }
    }

}
